
# http_port 3128 accel vhost
# visible_hostname squid-proxy

# # Configuración de logs con permisos
# cache_log /var/log/squid/cache.log
# access_log /var/log/squid/access.log
# logfile_rotate 0

# # Desactivar validación de cabeceras
# relaxed_header_parser on
# request_header_max_size 32 KB
# reply_header_max_size 32 KB

# # Configuración del backend
# cache_peer aspnet-app parent 8080 0 no-query originserver name=my_backend
# cache_peer_access my_backend allow all


# # Política de caché mejorada
# refresh_pattern . 1 100% 1 override-expire ignore-reload
# cache_mem 256 MB
# maximum_object_size 1024 MB
# cache_dir ufs /var/spool/squid 1000 16 256

# # ACL simplificada
# acl localnet src all
# acl all src all
# http_access allow localnet
# http_access allow all

# # Permitir solo método GET
# acl allowed_methods method GET
# http_access deny !allowed_methods



http_port 3128 vhost # O 'accel defaultsite=aspnet-app:8080' si prefieres la simplicidad
visible_hostname squid-proxy

# Configuración de logs
cache_log /var/log/squid/cache.log
access_log stdio:/var/log/squid/access.log squid # 'stdio' es para Docker logs
logfile_rotate 0

# Desactivar validación de cabeceras
relaxed_header_parser on
request_header_max_size 32 KB
reply_header_max_size 32 KB

# Configuración del backend (¡Sin 'originserver name=my_backend' para Squid 3.5.x!)
cache_peer aspnet-app parent 8080 0 no-query

# ACL para el hostname que envías en la solicitud (ej. localhost)
# Esta ACL es CRUCIAL con 'vhost'
acl host_to_backend dstdomain localhost # Asegúrate de que el cliente envíe 'Host: localhost'

# Reglas para dirigir el tráfico a este peer
cache_peer_access aspnet-app allow host_to_backend
cache_peer_access aspnet-app deny all # Denegar si no coincide con la ACL

never_direct allow all # Sigue siendo importante para proxy inverso


# Política de caché (simplificada y compatible con 3.5.x)
# Sin 'override-expire' si quieres que el backend controle la caché.
# Con 'override-expire' si quieres que Squid siempre intente cachear.
# Para CPDoS, a veces quieres que la respuesta de error del backend, aunque sea 'no-cache',
# se cachee por el proxy.

#refresh_pattern . 1 100% 1 override-expire ignore-private ignore-must-revalidate
negative_ttl 60 seconds
refresh_pattern -i . 0 20% 60 override-expire override-lastmod ignore-no-cache ignore-private ignore-auth


#cache_vary_request_headers User-Agent From Accept-Language Set-Cookie
# Tamaños de caché
cache_mem 256 MB
maximum_object_size 1024 MB
cache_dir ufs /var/spool/squid 1000 16 256

# ACL y control de acceso
acl all src all # Esto ya cubre 'localnet' si es todo
http_access allow all # Permitir acceso a todos para el lab (¡INSEGURO EN PROD!)

# Permitir solo GET (¡Esto bloqueará tus pruebas de POST/PUT/DELETE HMO!)
# Si quieres probar POST/PUT/DELETE, COMENTA o ELIMINA esta línea.
# acl allowed_methods method GET
# http_access deny !allowed_methods

# Permitir subrayados en hostnames
allow_underscore on
